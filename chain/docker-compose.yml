version: '3.8'

services:
  ethermint:
    image: evmos/evmos:latest
    container_name: evmbridge-ethermint
    ports:
      - "26657:26657"  # Tendermint RPC
      - "1317:1317"    # Cosmos REST API
      - "8545:8545"    # Ethereum JSON-RPC
      - "8546:8546"    # Ethereum WebSocket
    volumes:
      - ./data:/root/.evmosd
    command: >
      sh -c "
      if [ ! -d /root/.evmosd/config ]; then
        evmosd init evmbridge-node --chain-id evmbridge_9000-1 &&
        evmosd keys add validator --keyring-backend test &&
        evmosd add-genesis-account \$(evmosd keys show validator -a --keyring-backend test) 1000000000000000000000aevmos &&
        evmosd gentx validator 1000000000000000000aevmos --chain-id evmbridge_9000-1 --keyring-backend test &&
        evmosd collect-gentxs &&
        sed -i 's/cors_allowed_origins = \[\]/cors_allowed_origins = [\"*\"]/' /root/.evmosd/config/config.toml &&
        sed -i 's/enable = false/enable = true/' /root/.evmosd/config/app.toml &&
        sed -i 's/swagger = false/swagger = true/' /root/.evmosd/config/app.toml &&
        sed -i 's/enabled-unsafe-cors = false/enabled-unsafe-cors = true/' /root/.evmosd/config/app.toml;
      fi &&
      evmosd start --pruning=nothing --rpc.unsafe --json-rpc.api eth,txpool,personal,net,debug,web3 --json-rpc.enable
      "
    networks:
      - evmbridge-network
    restart: unless-stopped

networks:
  evmbridge-network:
    driver: bridge
